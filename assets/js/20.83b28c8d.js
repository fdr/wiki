(window.webpackJsonp=window.webpackJsonp||[]).push([[20],{285:function(t,a,s){"use strict";s.r(a);var e=s(13),n=Object(e.a)({},(function(){var t=this,a=t._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"use-generic-cloud-cloud-init-image-on-local"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#use-generic-cloud-cloud-init-image-on-local"}},[t._v("#")]),t._v(" Use Generic Cloud (cloud-init) image on local")]),t._v(" "),a("p",[t._v("You can use the Generic Cloud image for testing, developing and repackaging purposes on your local machine or server.")]),t._v(" "),a("h2",{attrs:{id:"almalinux-guest-os-support"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#almalinux-guest-os-support"}},[t._v("#")]),t._v(" AlmaLinux Guest OS support")]),t._v(" "),a("p",[t._v("You need at least the "),a("code",[t._v("20210215")]),t._v(" on AlmaLinux and "),a("code",[t._v("20210426")]),t._v(" version on the other distro's "),a("code",[t._v("osinfo-db")]),t._v(" package for the AlmaLinux Guest OS support.")]),t._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("TIP")]),t._v(" "),a("p",[a("code",[t._v("20210621")]),t._v(" and newer recommended for latest improvements.")])]),t._v(" "),a("p",[t._v("Check the list of supported guest OSes:")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("$ osinfo-query os\n\n Short ID             "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" Name                                               "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" Version  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" ID\n----------------------+----------------------------------------------------+----------+-----------------------------------------\n almalinux8           "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" AlmaLinux "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8")]),t._v("                                        "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8")]),t._v("        "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" http://almalinux.org/almalinux/8\n alpinelinux3.10      "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" Alpine Linux "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3.10")]),t._v("                                  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3.10")]),t._v("     "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" http://alpinelinux.org/alpinelinux/3.10\n alpinelinux3.11      "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" Alpine Linux "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3.11")]),t._v("                                  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3.11")]),t._v("     "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" http://alpinelinux.org/alpinelinux/3.11\n alpinelinux3.12      "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" Alpine Linux "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3.12")]),t._v("                                  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3.12")]),t._v("     "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" http://alpinelinux.org/alpinelinux/3.12\n alpinelinux3.13      "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" Alpine Linux "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3.13")]),t._v("                                  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3.13")]),t._v("     "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" http://alpinelinux.org/alpinelinux/3.13\n alpinelinux3.14      "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" Alpine Linux "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3.14")]),t._v("                                  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3.14")]),t._v("     "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" http://alpinelinux.org/alpinelinux/3.14\n alpinelinux3.5       "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" Alpine Linux "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3.5")]),t._v("                                   "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3.5")]),t._v("      "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" http://alpinelinux.org/alpinelinux/3.5\n alpinelinux3.6       "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" Alpine Linux "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3.6")]),t._v("                                   "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3.6")]),t._v("      "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" http://alpinelinux.org/alpinelinux/3.6\n alpinelinux3.7       "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" Alpine Linux "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3.7")]),t._v("                                   "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3.7")]),t._v("      "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" http://alpinelinux.org/alpinelinux/3.7\n alpinelinux3.8       "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" Alpine Linux "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3.8")]),t._v("                                   "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3.8")]),t._v("      "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" http://alpinelinux.org/alpinelinux/3.8\n alpinelinux3.9       "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" Alpine Linux "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3.9")]),t._v("                                   "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3.9")]),t._v("      "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" http://alpinelinux.org/alpinelinux/3.9\n alt.p8               "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" ALT p8 StarterKits                                 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" p8       "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" http://altlinux.org/alt/p8.starterkits\n alt.p9               "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" ALT p9 StarterKits                                 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" p9       "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" http://altlinux.org/alt/p9.starterkits\n alt.sisyphus         "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" ALT regular                                        "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" sisyphus "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" http://altlinux.org/alt/sisyphus\n alt8.0               "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" ALT "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8")]),t._v(" Education                                    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8.0")]),t._v("      "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" http://altlinux.org/alt/8.0\n alt8.1               "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" ALT "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8.1")]),t._v("                                            "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8.1")]),t._v("      "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" http://altlinux.org/alt/8.1\n alt8.2               "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" ALT "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8.2")]),t._v("                                            "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8.2")]),t._v("      "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" http://altlinux.org/alt/8.2\n alt9.0               "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" ALT "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("9.0")]),t._v("                                            "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("9.0")]),t._v("      "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" http://altlinux.org/alt/9.0\n alt9.1               "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" ALT "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("9.1")]),t._v("                                            "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("9.1")]),t._v("      "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" http://altlinux.org/alt/9.1\n altlinux1.0          "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" Mandrake RE Spring "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2001")]),t._v("                            "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1.0")]),t._v("      "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" http://altlinux.org/altlinux/1.0\n altlinux2.0          "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" ALT Linux "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2.0")]),t._v("                                      "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2.0")]),t._v("      "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" http://altlinux.org/altlinux/2.0\n altlinux2.2          "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" ALT Linux "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2.2")]),t._v("                                      "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2.2")]),t._v("      "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" http://altlinux.org/altlinux/2.2\n altlinux2.4          "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" ALT Linux "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2.4")]),t._v("                                      "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2.4")]),t._v("      "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" http://altlinux.org/altlinux/2.4\n altlinux3.0          "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" ALT Linux "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3.0")]),t._v("                                      "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3.0")]),t._v("      "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" http://altlinux.org/altlinux/3.0\n altlinux4.0          "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" ALT Linux "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4.0")]),t._v("                                      "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4.0")]),t._v("      "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" http://altlinux.org/altlinux/4.0\n altlinux4.1          "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" ALT Linux "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4.1")]),t._v("                                      "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4.1")]),t._v("      "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" http://altlinux.org/altlinux/4.1\n altlinux5.0          "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" ALT Linux "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5.0")]),t._v("                                      "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5.0")]),t._v("      "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" http://altlinux.org/altlinux/5.0\n altlinux6.0          "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" ALT Linux "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("6.0")]),t._v("                                      "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("6.0")]),t._v("      "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" http://altlinux.org/altlinux/6.0\n altlinux7.0          "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" ALT Linux "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("7.0")]),t._v("                                      "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("7.0")]),t._v("      "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" http://altlinux.org/altlinux/7.0\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".\n")])])]),a("p",[t._v("You can manually update the Osinfo database with the "),a("code",[t._v("--local")]),t._v(" option without overriding the osinfo-db which is installed by the distribution's package manager. The new database will have precedence when the database is loaded.")]),t._v(" "),a("p",[t._v("Check the latest version from here: "),a("a",{attrs:{href:"https://releases.pagure.org/libosinfo/?C=M;O=D",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://releases.pagure.org/libosinfo/?C=M;O=D"),a("OutboundLink")],1)]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Replace $VERSION with the latest version")]),t._v("\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" -O https://releases.pagure.org/libosinfo/osinfo-db-"),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$VERSION")]),t._v(".tar.xz "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Download")]),t._v("\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" osinfo-db-import --local osinfo-db-"),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$VERSION")]),t._v(".tar.xz "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#Install")]),t._v("\n")])])]),a("p",[t._v("Download and Verify the cloud image from this guide: "),a("a",{attrs:{href:"https://wiki.almalinux.org/cloud/Generic-cloud.html#download-and-verification",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://wiki.almalinux.org/cloud/Generic-cloud.html#download-and-verification"),a("OutboundLink")],1)]),t._v(" "),a("h2",{attrs:{id:"create-a-snapshot-from-the-image"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#create-a-snapshot-from-the-image"}},[t._v("#")]),t._v(" Create a snapshot from the image")]),t._v(" "),a("p",[t._v("If you don't want to modify the cloud image on each VM creation, you can create a snapshot from the cloud image. The snapshot's virtual size can be different from the base image. In this example, we will use 20G instead of the base image's virtual size (10G). Cloud-init will grow the root filesystem automatically on the creation of the VM.")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("$ qemu-img create -f qcow2 -b AlmaLinux-8-GenericCloud-8.4-20210616.x86_64.qcow2 -F qcow2 wiki-almalinux84-snapshot.qcow2 20G\n")])])]),a("h2",{attrs:{id:"cloud-init"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#cloud-init"}},[t._v("#")]),t._v(" Cloud-init")]),t._v(" "),a("p",[t._v("The "),a("a",{attrs:{href:"https://cloudinit.readthedocs.io/en/latest/topics/datasources/nocloud.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("NoCloud"),a("OutboundLink")],1),t._v(" Datasource allows the user to provide User-data and Meta-data to the instance without running a network service (or even without having a network at all). You can provide Meta-data and User-data files with "),a("code",[t._v("--cloud-init")]),t._v(" option of "),a("a",{attrs:{href:"https://virt-manager.org/",target:"_blank",rel:"noopener noreferrer"}},[t._v("virt-install"),a("OutboundLink")],1),t._v(" >= 3.0.0 or with a ISO file for < 3.0.0.")]),t._v(" "),a("p",[t._v("The accounts on the cloud image locked by default. You can set a password with the "),a("a",{attrs:{href:"https://cloudinit.readthedocs.io/en/latest/topics/modules.html#set-passwords",target:"_blank",rel:"noopener noreferrer"}},[t._v("Set Password"),a("OutboundLink")],1),t._v(", add your ssh public key with "),a("a",{attrs:{href:"https://cloudinit.readthedocs.io/en/latest/topics/modules.html#authorized-keys",target:"_blank",rel:"noopener noreferrer"}},[t._v("Authorized Keys"),a("OutboundLink")],1),t._v(". In this example, we will set a password for the default "),a("code",[t._v("almalinux")]),t._v(" user.")]),t._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("TIP")]),t._v(" "),a("p",[t._v("Check cloud-init modules "),a("a",{attrs:{href:"https://cloudinit.readthedocs.io/en/latest/topics/modules.html#",target:"_blank",rel:"noopener noreferrer"}},[t._v("list"),a("OutboundLink")],1),t._v(" for further customization options.")])]),t._v(" "),a("p",[a("code",[t._v("user-data:")])]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#cloud-config")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ssh_pwauth")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" yes "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#  sshd will be configured to accept password authentication")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("password")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'P@$$W0RD'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Set a password for almalinux Cloud User")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("chpasswd")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("expire")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("false")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ssh_authorized_keys")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Add your ssh public key for publickey authentication ")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" ssh"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("rsa AAAAB3NzaC1yc2EAAAABIwAAAGEA3FSyQwBI6Z+nCSjUU "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("...")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" ssh"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("rsa AAAAB3NzaC1yc2EAAAABIwAAAQEA3I7VUf2l5gSn5uavROsc5HRDpZ "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("...")]),t._v("\n\n")])])]),a("p",[t._v("Start the VM - "),a("code",[t._v("virt-install >= 3.0.0")]),t._v(" with "),a("code",[t._v("--cloud-init")]),t._v(" option:")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token shebang important"}},[t._v("#!/usr/bin/env bash")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("VM_NAME")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"wiki-almalinux84"')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("USER_DATA")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"user-data"')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("DISK")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"wiki-almalinux84-snapshot.qcow2"')]),t._v("\n\n\nvirt-install "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--name "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("${VM_NAME}")]),t._v('"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--memory "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2048")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--vcpus "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--import "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--cloud-init user-data"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("${USER_DATA}")]),t._v('"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--os-variant almalinux8 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--disk "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("${DISK}")]),t._v('"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--network "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("network")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("default,model"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("virtio "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--graphics none "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--virt-type kvm\n\n")])])]),a("p",[t._v("Start the VM - "),a("code",[t._v("virt-install < 3.0.0")])]),t._v(" "),a("p",[t._v("Create a CloudInit seed iso file with User-Data and Meta-Data:")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("touch")]),t._v(" meta-data "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# empty meta-data file for no meta-data option")]),t._v("\n$ genisoimage -output seed.iso -volid cidata -joliet -rock user-data meta-data\n")])])]),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token shebang important"}},[t._v("#!/usr/bin/env bash")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("VM_NAME")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"wiki-almalinux84"')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("DISK")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"wiki-almalinux84-snapshot.qcow2"')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("SEED_ISO")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"seed.iso"')]),t._v("\n\n\nvirt-install "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--name "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("${VM_NAME}")]),t._v('"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--memory "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2048")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--vcpus "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--import "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--os-variant almalinux8 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--disk "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("${DISK}")]),t._v('"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--disk "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("${SEED_ISO}")]),t._v('"')]),t._v(",device"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("cdrom "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--network "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("network")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("default,model"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("virtio "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--graphics none "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--virt-type kvm\n\n")])])]),a("p",[t._v("Get the IP address of the VM:")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("virsh")]),t._v(" domainifaddr "),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$VM_NAME")]),t._v("\n")])])]),a("h2",{attrs:{id:"static-ip"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#static-ip"}},[t._v("#")]),t._v(" Static IP")]),t._v(" "),a("p",[t._v("You need a Cloud-init Meta-Data file for the static IP configuration.")]),t._v(" "),a("p",[a("code",[t._v("meta-data:")])]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("network-interfaces")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("|")]),a("span",{pre:!0,attrs:{class:"token scalar string"}},[t._v("\n  iface eth0 inet static\n  address 192.168.122.8\n  network 192.168.122.0\n  netmask 255.255.255.0\n  broadcast 192.168.1.255\n  gateway 192.168.122.1")]),t._v("\n")])])]),a("p",[t._v("Because of a current "),a("a",{attrs:{href:"https://bugs.launchpad.net/cloud-init/+bug/1225922",target:"_blank",rel:"noopener noreferrer"}},[t._v("bug"),a("OutboundLink")],1),t._v(" in cloud-init, static networking configurations are not automatically started. Instead, the default DHCP configuration remains active. A suggested workaround is to manually stop and restart the network interface via the "),a("code",[t._v("bootcmd")]),t._v(".")]),t._v(" "),a("p",[t._v("Add these lines in the User-Data file.")]),t._v(" "),a("p",[a("code",[t._v("user-data:")])]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#cloud-config")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("bootcmd")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" ifdown eth0\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" ifup eth0\n")])])]),a("p",[t._v("Create a VM with static IP:")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token shebang important"}},[t._v("#!/usr/bin/env bash")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("VM_NAME")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"wiki-almalinux84"')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("META_DATA")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"meta-data"')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("USER_DATA")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"user-data"')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("DISK")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"wiki-almalinux84-snapshot.qcow2"')]),t._v("\n\nvirt-install "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--name "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("${VM_NAME}")]),t._v('"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--memory "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2048")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--vcpus "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--import "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--cloud-init meta-data"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("${META_DATA}")]),t._v('"')]),t._v(",user-data"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("${USER_DATA}")]),t._v('"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--os-variant almalinux8 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--disk "),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("${DISK}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--network "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("network")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("default,model"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("virtio "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--graphics none "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--virt-type kvm\n\n")])])]),a("h2",{attrs:{id:"repackage-cloud-image"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#repackage-cloud-image"}},[t._v("#")]),t._v(" Repackage cloud image")]),t._v(" "),a("p",[t._v("shutdown VM:")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("virsh")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("shutdown")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$VM_NAME")]),t._v("\n")])])]),a("p",[t._v("Convert the snapshot to the full image without touching backing file("),a("code",[t._v("AlmaLinux-8-GenericCloud-8.4-20210616.x86_64.qcow2")]),t._v("):")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("$ qemu-img convert -c -O qcow2 doc-almalinux84-snapshot.qcow2 doc-almalinux84-base.qcow2\n")])])]),a("p",[t._v("You can reset, unconfigure and inject files to the image with "),a("code",[t._v("libguestfs virt-sysprep")]),t._v(". See the upstream documentation for further "),a("a",{attrs:{href:"https://libguestfs.org/virt-sysprep.1.html#options",target:"_blank",rel:"noopener noreferrer"}},[t._v("option"),a("OutboundLink")],1),t._v(" and "),a("a",{attrs:{href:"https://libguestfs.org/virt-sysprep.1.html#operations",target:"_blank",rel:"noopener noreferrer"}},[t._v("operations."),a("OutboundLink")],1)]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("$ virt-sysprep --format qcow2 -a doc-almalinux84-base.qcow2\n")])])])])}),[],!1,null,null,null);a.default=n.exports}}]);